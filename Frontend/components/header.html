<header class="header" id="header">
  <div class="container">
    <div class="header-content">
      <a href="/" class="logo flex items-center space-x-2">
        <img src="../assets/images/logo-navy.svg" alt="Readify" class="h-8 w-8 object-contain" />
        <span class="logo">Readify</span>
      </a>
      <nav class="nav">
        <ul class="nav-menu">
          <li><a href="/" class="nav-link">Trang chủ</a></li>
          <li class="relative group">
            <a href="books" class="nav-link">Cửa Hàng</a>

          </li>
          <li class="relative group" id="categoryMenu" style="z-index:51;">
            <a href="searchBooks" class="nav-link flex items-center gap-2">
              <i class="ri-list-unordered text-lg"></i>
              Thể loại
              <svg class="ml-1 w-4 h-4 text-gray-500 group-hover:text-primarynavy transition" fill="none"
                stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M19 9l-7 7-7-7" />
              </svg>
            </a>
            <!-- Hover bridge: invisible div để giữ hover khi di chuyển chuột giữa menu và mega menu -->
            <div id="categoryHoverBridge"
              style="position:absolute;left:50%;transform:translateX(-50%);top:100%;width:120px;height:32px;z-index:51;pointer-events:auto;">
            </div>
            <div id="categoryMegaMenu"
              class="fixed left-0 right-0 mx-auto top-18 w-[1450px] bg-white shadow-2xl border border-gray-100 mt-3 py-6 px-12 rounded-2xl opacity-0 pointer-events-none group-hover:opacity-100 group-hover:pointer-events-auto group-focus-within:opacity-100 group-focus-within:pointer-events-auto z-50 flex flex-row flex-nowrap justify-between gap-8 text-left transition-opacity duration-300"
              style="min-width:400px; transition: opacity 0.5s, visibility 0.5s;">
              <div class="flex flex-row w-full gap-4 overflow-x-auto">
                <!-- Categories will be dynamically loaded here -->
              </div>
          </li>
          <li><a href="reviews" class="nav-link">Đánh giá</a></li>
          <li><a href="about" class="nav-link">Về chúng tôi</a></li>
        </ul>
      </nav>
      <div class="header-actions relative">
        <button
          class="search-btn w-10 h-10 flex items-center justify-center rounded-full transition-colors duration-200 hover:bg-primarynavy hover:text-white focus:outline-none focus:ring-2 focus:ring-primarynavy"
          aria-label="Search">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>

        <button id="cartBtn"
          class="cart-btn cart-badge w-10 h-10 flex items-center justify-center rounded-full transition-colors duration-200 hover:bg-primarynavy hover:text-white focus:outline-none focus:ring-2 focus:ring-primarynavy"
          aria-label="Shopping Cart">
          <i class="ri-shopping-cart-2-line text-xl"></i>
        </button>

        <button id="userBtn"
          class="user-btn ml-2 w-10 h-10 flex items-center justify-center rounded-full transition-colors duration-200 hover:bg-primarynavy hover:text-white focus:outline-none focus:ring-2 focus:ring-primarynavy"
          aria-label="User">
          <i class="ri-user-line text-xl"></i>
        </button>

        <!-- User info khi đã đăng nhập -->
        <div id="userInfo" class="hidden ml-2 flex items-center space-x-3 cursor-pointer"
          title="Nhấn để xem menu tài khoản">
          <div class="text-right">
            <div id="headerUserName" class="font-medium text-gray-800 text-sm max-w-32 truncate">User</div>
            <div class="text-xs text-green-600 font-medium">● Đã đăng nhập</div>
          </div>
          <button id="userInfoBtn"
            class="w-10 h-10 flex items-center justify-center rounded-full bg-primarynavy text-white transition-colors duration-200 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-primarynavy"
            aria-label="User Menu">
            <i class="ri-user-3-fill text-xl"></i>
          </button>
        </div>

      </div>
    </div>
  </div>
</header>
<!-- Slide-in user panel -->
<div id="userPanel" class="fixed top-0 right-0 h-full w-80 max-w-full bg-white shadow-2xl border-l border-gray-200 z-[9999] rounded-l-xl
  translate-x-full hidden transition-transform duration-300 ease-in-out
  flex flex-col">
  <div class="flex items-center justify-between p-5 border-b">
    <span class="font-bold text-lg text-gray-800">Tài khoản</span>
    <button id="closeUserPanel" class="text-gray-500 hover:text-primarynavy text-2xl">&times;</button>
  </div>
  <div class="p-5 space-y-4 flex-1 flex flex-col">

    <a href="orders"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-primary/20 transition text-gray-800 font-medium">
      <i class="ri-file-list-3-line text-xl"></i> Đơn hàng của tôi
    </a>
    <a href="wishlist"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-primary/20 transition text-gray-800 font-medium">
      <i class="ri-heart-line text-xl"></i> Sách yêu thích
    </a>

    <a href="settings"
      class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-primary/20 transition text-gray-800 font-medium">
      <i class="ri-settings-3-line text-xl"></i> Cài đặt tài khoản
    </a>

    <!-- User not logged in -->
    <div id="guestActions" class="space-y-2 mt-auto">
      <div class="text-center text-gray-500 text-sm mb-3">
        <i class="ri-information-line mr-1"></i>
        Đăng nhập để trải nghiệm đầy đủ tính năng
      </div>
      <a href="login" id="loginLink"
        class="block w-full bg-primarynavy text-white px-4 py-3 rounded-lg text-center font-semibold hover:bg-blue-700 transition-colors">
        <i class="ri-login-circle-line mr-2"></i>Đăng nhập</a>
      <a href="register" id="registerLink"
        class="block w-full bg-white text-primarynavy border border-primarynavy px-4 py-3 rounded-lg text-center font-semibold hover:bg-gray-50 transition-colors">
        <i class="ri-user-add-line mr-2"></i>Tạo tài khoản</a>
    </div>


    <!-- User logged in -->
    <div id="userActions" class="hidden">
      <!-- User profile section -->
      <div id="userWelcome" class="px-4 py-3 bg-gradient-to-r from-primarynavy to-blue-600 rounded-lg text-white mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
            <i class="ri-user-3-fill text-2xl"></i>
          </div>
          <div>
            <div class="text-sm opacity-90">Xin chào,</div>
            <div id="userName" class="font-semibold text-lg">User</div>
          </div>
        </div>
      </div>

      <!-- Logout button at bottom -->
      <div class="mt-auto pt-4 border-t border-gray-200">
        <button id="logoutBtn"
          class="block w-full bg-red-500 text-white px-4 py-3 rounded-lg text-center font-semibold hover:bg-red-600 transition-colors">
          <i class="ri-logout-circle-line mr-2"></i>Đăng xuất
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Slide-in cart panel -->
<div id="cartPanel" class="fixed top-0 right-0 h-full w-96 max-w-full bg-white shadow-2xl border-l border-gray-200 z-[9999] rounded-l-xl
  translate-x-full hidden transition-transform duration-300 ease-in-out
  flex flex-col">
  <div class="flex items-center justify-between p-5 border-b">
    <span class="font-bold text-lg text-gray-800">Giỏ hàng của bạn</span>
    <button id="closeCartPanel" class="text-gray-500 hover:text-primarynavy text-2xl">&times;</button>
  </div>
  <div class="flex-1 overflow-y-auto p-5 space-y-4" id="cartItems">
    <!-- Hiển thị sản phẩm trong giỏ hàng, ví dụ: -->
    <div class="flex items-center gap-3" id="cartItemExample">
      <img
        src="https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1495635816i/32521178.jpg"
        alt="Sách" class="w-14 h-20 object-cover rounded border" />
      <div class="flex-1">
        <div class="font-medium text-gray-800">Tuổi trẻ đáng giá bao nhiêu</div>
        <div class="text-sm text-gray-500">Rosie Nguyễn</div>
        <div class="flex items-center gap-2 mt-1">
          <span class="text-primarynavy font-semibold">120.000đ</span>
          <span class="text-xs text-gray-400 line-through">150.000đ</span>
        </div>
        <div class="flex items-center gap-2 mt-2">
          <button class="px-2 py-1 border rounded">-</button>
          <input type="number" min="1" value="1"
            class="w-12 text-center border rounded focus:outline-none focus:ring-2 focus:ring-primarynavy no-spinner" />
          <button class="px-2 py-1 border rounded">+</button>
          <button class="ml-2 text-red-500 hover:underline text-l">Xóa</button>
        </div>
      </div>
    </div>
    <div class="text-gray-500 text-center" id="cartEmptyMsg" style="display: none;">Chưa có sản phẩm nào trong giỏ hàng.
    </div>
  </div>
  <div class="p-5 border-t">
    <div class="flex justify-between items-center mb-4">
      <span class="font-medium text-gray-700">Tạm tính:</span>
      <span class="font-bold text-lg text-primarynavy" id="cartTotal">0đ</span>
    </div>
    <!-- <a href="orders"
      class="cart-checkout-btn block w-full bg-primarynavy text-white px-4 py-3 rounded-lg text-center font-semibold mb-2 hover:bg-blue-700 transition-colors">
      <i class="ri-shopping-bag-line mr-2"></i>Xem giỏ hàng
    </a> -->
    <a href="checkout"
      class="cart-checkout-btn block w-full bg-white text-primarynavy border border-primarynavy px-4 py-3 rounded-lg text-center font-semibold hover:bg-gray-50 transition-colors">
      <i class="ri-secure-payment-line mr-2"></i>Thanh toán
    </a>
  </div>
</div>

<style>
  /* Ẩn mũi tên tăng giảm mặc định trên input[type=number] cho Chrome, Safari, Edge */
  input[type=number].no-spinner::-webkit-inner-spin-button,
  input[type=number].no-spinner::-webkit-outer-spin-button {
    -webkit-appearance: none;
    appearance: none;
    margin: 0;
  }

  /* Cart badge styles */
  .cart-badge {
    position: relative;
  }

  .cart-badge[data-count]::after {
    content: attr(data-count);
    position: absolute;
    top: -8px;
    right: -8px;
    background-color: #ef4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    animation: cartBadgePulse 0.3s ease-out;
  }

  .cart-badge.cart-has-items {
    animation: cartButtonPulse 0.3s ease-out;
  }

  /* Line clamp utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Cart animations */
  @keyframes cartBadgePulse {
    0% {
      transform: scale(0.8);
      opacity: 0;
    }

    50% {
      transform: scale(1.2);
    }

    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes cartButtonPulse {
    0% {
      transform: scale(1);
    }

    50% {
      transform: scale(1.1);
    }

    100% {
      transform: scale(1);
    }
  }

  /* Cart item hover effects */
  .cart-item {
    transition: all 0.2s ease-in-out;
  }

  .cart-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Button disabled state */
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
<script>
  // Tối ưu hover mega menu: chỉ ẩn khi chuột rời hoàn toàn khỏi cả menu và mega menu
  (function () {
    const menu = document.getElementById('categoryMenu');
    const mega = document.getElementById('categoryMegaMenu');
    const bridge = document.getElementById('categoryHoverBridge');
    let isOverMenu = false;
    let isOverMega = false;
    let isOverBridge = false;
    function showMenu() {
      mega.classList.add('opacity-100', 'pointer-events-auto');
      mega.classList.remove('opacity-0', 'pointer-events-none');
    }
    function hideMenu() {
      if (!isOverMenu && !isOverMega && !isOverBridge) {
        mega.classList.remove('opacity-100', 'pointer-events-auto');
        mega.classList.add('opacity-0', 'pointer-events-none');
      }
    }
    if (menu && mega && bridge) {
      menu.addEventListener('mouseenter', () => {
        isOverMenu = true;
        showMenu();
      });
      menu.addEventListener('mouseleave', () => {
        isOverMenu = false;
        setTimeout(hideMenu, 10);
      });
      mega.addEventListener('mouseenter', () => {
        isOverMega = true;
        showMenu();
      });
      mega.addEventListener('mouseleave', () => {
        isOverMega = false;
        setTimeout(hideMenu, 10);
      });
      bridge.addEventListener('mouseenter', () => {
        isOverBridge = true;
        showMenu();
      });
      bridge.addEventListener('mouseleave', () => {
        isOverBridge = false;
        setTimeout(hideMenu, 10);
      });
    }
  })();

  // Luồng chuyển trang category: event delegation, SPA-like nếu đang ở searchBooks (không cần .html)
  (function () {
    const megaMenu = document.getElementById('categoryMegaMenu');
    if (!megaMenu) return;
    megaMenu.addEventListener('click', function (e) {
      let link = e.target.closest('a[data-category]');
      if (!link && e.target.tagName === 'LI') {
        link = e.target.querySelector('a[data-category]');
      }
      if (!link) return;
      // Chỉ xử lý khi click chuột trái không có modifier (để Ctrl+click, chuột phải, middle mouse vẫn mở tab mới/copy link đúng)
      if (e.button !== 0 || e.ctrlKey || e.metaKey || e.shiftKey || e.altKey) return;
      e.preventDefault();
      const category = link.getAttribute('data-category');
      // Luôn chuyển hướng về đúng domain gốc + /searchBooks?category=...
      const targetUrl = '/searchBooks?category=' + encodeURIComponent(category);
      // Xác định pathname hiện tại (bỏ hết .html, thư mục con)
      const currentPath = window.location.pathname.replace(/\/+/g, '/').replace(/\.html$/, '');
      // Hỗ trợ cả file://
      const isSearchBooks = /\/searchBooks$/i.test(currentPath);
      if (isSearchBooks) {
        // Nếu đã ở searchBooks, chỉ pushState và phát event SPA
        window.history.pushState({}, '', targetUrl);
        window.dispatchEvent(new CustomEvent('categoryFilterChange', { detail: { category } }));
      } else {
        // Nếu không, chuyển trang đúng domain (hỗ trợ file://)
        if (window.location.origin === 'null' || window.location.origin === 'file://') {
          window.location.href = targetUrl;
        } else {
          window.location.href = window.location.origin + targetUrl;
        }
      }
    });
  })();

</script>